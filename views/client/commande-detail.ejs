<div class="container py-4">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/mes-commandes">Mes commandes</a></li>
      <li class="breadcrumb-item active">#<%= commande.numero %></li>
    </ol>
  </nav>

  <%
    const statutColors = {
      en_attente: 'warning',
      confirmee: 'info',
      en_preparation: 'primary',
      prete: 'success',
      livree: 'success',
      recuperee: 'success',
      annulee: 'danger'
    };
    const statutLabels = {
      en_attente: 'En attente',
      confirmee: 'Confirmee',
      en_preparation: 'En preparation',
      prete: 'Prete a recuperer',
      livree: 'Livree',
      recuperee: 'Recuperee',
      annulee: 'Annulee'
    };
    const steps = ['en_attente', 'confirmee', 'en_preparation', 'prete', 'recuperee'];
    const currentStep = steps.indexOf(commande.statut);
  %>

  <div class="row">
    <div class="col-md-8">
      <div class="card shadow-sm mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h4 class="mb-0">Commande #<%= commande.numero %></h4>
          <span class="badge bg-<%= statutColors[commande.statut] || 'secondary' %> fs-6">
            <%= statutLabels[commande.statut] || commande.statut %>
          </span>
        </div>
        <div class="card-body">
          <!-- Progress tracker -->
          <% if (commande.statut !== 'annulee') { %>
            <div class="d-flex justify-content-between mb-4">
              <% steps.forEach((step, i) => { %>
                <div class="text-center flex-fill">
                  <div class="rounded-circle mx-auto d-flex align-items-center justify-content-center"
                    style="width: 40px; height: 40px; background: <%= i <= currentStep ? '#4CAF50' : '#E0E0E0' %>; color: white;">
                    <% if (i < currentStep) { %>
                      <i class="fas fa-check"></i>
                    <% } else { %>
                      <%= i + 1 %>
                    <% } %>
                  </div>
                  <small class="d-none d-md-block mt-1 <%= i <= currentStep ? 'text-success fw-bold' : 'text-muted' %>">
                    <%= statutLabels[step] %>
                  </small>
                </div>
              <% }); %>
            </div>
          <% } %>

          <!-- Articles -->
          <h5>Articles</h5>
          <% commande.articles.forEach(article => { %>
            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
              <div class="d-flex align-items-center">
                <% if (article.produit && article.produit.images && article.produit.images.length > 0) { %>
                  <img src="<%= article.produit.images[0] %>" class="rounded me-3"
                    style="width: 60px; height: 60px; object-fit: cover;">
                <% } %>
                <div>
                  <strong><%= article.titre %></strong>
                  <br><small class="text-muted"><%= article.prix.toLocaleString() %> FCFA x <%= article.quantite %></small>
                  <% if (article.options) { %>
                    <br><small class="text-info">Options: <%= article.options %></small>
                  <% } %>
                </div>
              </div>
              <strong><%= article.sousTotal.toLocaleString() %> FCFA</strong>
            </div>
          <% }); %>

          <div class="mt-3">
            <div class="d-flex justify-content-between">
              <span>Sous-total</span>
              <span><%= commande.montantTotal.toLocaleString() %> FCFA</span>
            </div>
            <div class="d-flex justify-content-between">
              <span>Frais livraison</span>
              <span><%= commande.fraisLivraison.toLocaleString() %> FCFA</span>
            </div>
            <hr>
            <div class="d-flex justify-content-between fw-bold fs-5">
              <span>Total</span>
              <span class="text-primary"><%= commande.montantFinal.toLocaleString() %> FCFA</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Historique -->
      <% if (commande.historique && commande.historique.length > 0) { %>
        <div class="card shadow-sm">
          <div class="card-header"><strong>Historique</strong></div>
          <div class="card-body">
            <% commande.historique.forEach(h => { %>
              <div class="d-flex align-items-start mb-2">
                <i class="fas fa-circle text-primary me-2 mt-1" style="font-size: 0.5rem;"></i>
                <div>
                  <strong><%= statutLabels[h.statut] || h.statut %></strong>
                  <small class="text-muted d-block"><%= new Date(h.date).toLocaleString('fr-FR') %></small>
                  <% if (h.commentaire) { %>
                    <small class="text-muted"><%= h.commentaire %></small>
                  <% } %>
                </div>
              </div>
            <% }); %>
          </div>
        </div>
      <% } %>
    </div>

    <div class="col-md-4">
      <!-- Boutique info -->
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <h5><i class="fas fa-store me-2"></i>Boutique</h5>
          <% if (commande.boutique) { %>
            <p class="mb-1"><strong><%= commande.boutique.nom %></strong></p>
            <p class="mb-1 text-muted">
              <i class="fas fa-map-marker-alt me-1"></i>
              <%= commande.boutique.localisation.commune %>, <%= commande.boutique.localisation.ville || 'Abidjan' %>
            </p>
            <p class="mb-0 text-muted">
              <i class="fas fa-phone me-1"></i><%= commande.boutique.telephone %>
            </p>
          <% } %>
        </div>
      </div>

      <!-- Infos commande -->
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <h5><i class="fas fa-info-circle me-2"></i>Details</h5>
          <p class="mb-1"><strong>Mode :</strong> <%= commande.modeRecuperation === 'retrait' ? 'Retrait en boutique' : 'Livraison' %></p>
          <p class="mb-1"><strong>Date :</strong> <%= new Date(commande.dateRecuperation).toLocaleDateString('fr-FR') %></p>
          <p class="mb-1"><strong>Paiement :</strong> <%= commande.paiement.methode.replace(/_/g, ' ') %></p>
          <p class="mb-0"><strong>Ref :</strong> <%= commande.paiement.reference %></p>
          <% if (commande.notes) { %>
            <hr>
            <p class="mb-0"><strong>Notes :</strong> <%= commande.notes %></p>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>
